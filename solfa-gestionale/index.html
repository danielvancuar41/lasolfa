<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestionale Acquisti ‚Äî Osteria La Sol Fa</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  :root {
    --carta: #f5ede0;
    --carta-dark: #e8d9c5;
    --inchiostro: #1a1008;
    --rosso: #8b1a1a;
    --rosso-light: #c0392b;
    --verde: #2d5a27;
    --oro: #b8860b;
    --oro-light: #d4a017;
    --grigio: #6b5d4f;
    --bianco: #fdfaf6;
    --ombra: rgba(26,16,8,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Libre Baskerville', serif;
    background: var(--carta);
    color: var(--inchiostro);
    min-height: 100vh;
    background-image:
      url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b8860b' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  }

  /* ===== LOGIN ===== */
  #login-screen {
    position: fixed; inset: 0;
    background: var(--inchiostro);
    display: flex; align-items: center; justify-content: center;
    z-index: 999;
    background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b8860b' fill-opacity='0.06'%3E%3Cpath d='M50 50c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10zM10 10c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10S0 25.523 0 20s4.477-10 10-10z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  }
  .login-box {
    background: var(--carta);
    padding: 56px 48px;
    max-width: 420px;
    width: 90%;
    text-align: center;
    position: relative;
    border: 2px solid var(--oro);
    box-shadow: 0 0 0 8px rgba(184,134,11,0.1), 0 32px 80px rgba(0,0,0,0.5);
  }
  .login-box::before {
    content: '';
    position: absolute; inset: 8px;
    border: 1px solid rgba(184,134,11,0.3);
    pointer-events: none;
  }
  .login-logo {
    font-family: 'Playfair Display', serif;
    font-size: 14px;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--oro);
    margin-bottom: 8px;
  }
  .login-title {
    font-family: 'Playfair Display', serif;
    font-size: 32px;
    font-weight: 900;
    color: var(--inchiostro);
    line-height: 1.1;
    margin-bottom: 6px;
  }
  .login-sub {
    font-size: 13px;
    color: var(--grigio);
    font-style: italic;
    margin-bottom: 36px;
  }
  .login-box input {
    width: 100%;
    padding: 14px 18px;
    font-family: 'DM Mono', monospace;
    font-size: 20px;
    letter-spacing: 8px;
    text-align: center;
    background: var(--carta-dark);
    border: 2px solid var(--oro);
    color: var(--inchiostro);
    outline: none;
    margin-bottom: 16px;
    transition: border-color 0.2s;
  }
  .login-box input:focus { border-color: var(--rosso); }
  .login-btn {
    width: 100%;
    padding: 14px;
    background: var(--rosso);
    color: var(--carta);
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
  }
  .login-btn:hover { background: var(--rosso-light); }
  .login-error {
    color: var(--rosso);
    font-size: 12px;
    margin-top: 10px;
    font-style: italic;
    min-height: 20px;
  }

  /* ===== APP SHELL ===== */
  #app { display: none; min-height: 100vh; }

  header {
    background: var(--inchiostro);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 16px rgba(0,0,0,0.3);
  }
  .header-brand {
    font-family: 'Playfair Display', serif;
    font-size: 13px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--oro);
  }
  .header-brand span { color: rgba(255,255,255,0.5); font-size: 11px; display: block; letter-spacing: 1px; }

  nav { display: flex; gap: 4px; }
  nav button {
    padding: 8px 18px;
    font-family: 'Libre Baskerville', serif;
    font-size: 13px;
    background: transparent;
    color: rgba(255,255,255,0.6);
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
  }
  nav button:hover { color: white; border-color: rgba(255,255,255,0.2); }
  nav button.active { color: var(--oro); border-color: var(--oro); background: rgba(184,134,11,0.1); }

  .logout-btn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.5);
    padding: 6px 14px;
    font-size: 12px;
    cursor: pointer;
    font-family: 'Libre Baskerville', serif;
    transition: all 0.2s;
  }
  .logout-btn:hover { color: white; border-color: white; }

  main { max-width: 1200px; margin: 0 auto; padding: 40px 24px; }

  .page { display: none; }
  .page.active { display: block; }

  /* ===== SECTION TITLE ===== */
  .section-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--inchiostro);
  }
  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 36px;
    font-weight: 900;
    color: var(--inchiostro);
    line-height: 1;
  }
  .section-title small {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--grigio);
    font-weight: 400;
    letter-spacing: 2px;
    text-transform: uppercase;
    display: block;
    margin-bottom: 4px;
  }

  /* ===== CARDS / PANNELLI ===== */
  .card {
    background: var(--bianco);
    border: 1px solid var(--carta-dark);
    padding: 28px;
    margin-bottom: 24px;
    box-shadow: 0 2px 12px var(--ombra);
  }
  .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--inchiostro);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .card-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: var(--rosso);
    display: inline-block;
  }

  /* ===== FORM STYLES ===== */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    align-items: end;
  }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  label {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--grigio);
  }
  input[type="text"], input[type="number"], input[type="date"], select, textarea {
    padding: 10px 14px;
    font-family: 'Libre Baskerville', serif;
    font-size: 14px;
    background: var(--carta);
    border: 1px solid var(--carta-dark);
    border-bottom: 2px solid var(--inchiostro);
    color: var(--inchiostro);
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }
  input:focus, select:focus, textarea:focus {
    border-bottom-color: var(--rosso);
    background: var(--bianco);
  }
  select { cursor: pointer; }

  .btn {
    padding: 11px 24px;
    font-family: 'Playfair Display', serif;
    font-size: 14px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn-primary { background: var(--inchiostro); color: var(--carta); }
  .btn-primary:hover { background: var(--rosso); }
  .btn-danger { background: var(--rosso); color: white; font-size: 12px; padding: 6px 12px; }
  .btn-danger:hover { background: #6b1111; }
  .btn-success { background: var(--verde); color: white; }
  .btn-success:hover { background: #1e3d1a; }
  .btn-gold { background: var(--oro); color: var(--inchiostro); }
  .btn-gold:hover { background: var(--oro-light); }
  .btn-outline {
    background: transparent;
    border: 2px solid var(--inchiostro);
    color: var(--inchiostro);
  }
  .btn-outline:hover { background: var(--inchiostro); color: var(--carta); }
  .btn-sm { padding: 7px 14px; font-size: 12px; }

  /* ===== ACQUISTI TABLE ===== */
  .acquisti-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  .acquisti-table th {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--grigio);
    padding: 10px 12px;
    text-align: left;
    border-bottom: 2px solid var(--inchiostro);
    background: var(--carta);
  }
  .acquisti-table td {
    padding: 12px;
    border-bottom: 1px solid var(--carta-dark);
    vertical-align: middle;
  }
  .acquisti-table tr:hover td { background: rgba(184,134,11,0.04); }
  .acquisti-table .prodotto-img {
    width: 36px; height: 36px;
    object-fit: cover;
    border-radius: 2px;
    border: 1px solid var(--carta-dark);
    vertical-align: middle;
  }
  .img-placeholder {
    width: 36px; height: 36px;
    background: var(--carta-dark);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    border: 1px solid var(--carta-dark);
    vertical-align: middle;
  }

  .totale-bar {
    background: var(--inchiostro);
    color: var(--carta);
    padding: 20px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0;
  }
  .totale-label {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.6);
  }
  .totale-value {
    font-family: 'Playfair Display', serif;
    font-size: 32px;
    font-weight: 900;
    color: var(--oro);
  }

  /* ===== PRODOTTI CATALOG ===== */
  .prodotti-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }
  .prodotto-card {
    background: var(--bianco);
    border: 1px solid var(--carta-dark);
    padding: 16px;
    display: flex;
    gap: 14px;
    align-items: flex-start;
    transition: box-shadow 0.2s;
    position: relative;
  }
  .prodotto-card:hover { box-shadow: 0 4px 20px var(--ombra); }
  .prodotto-img-wrap {
    width: 60px; height: 60px;
    flex-shrink: 0;
    position: relative;
    cursor: pointer;
  }
  .prodotto-img-wrap img, .prodotto-img-wrap .img-placeholder-lg {
    width: 100%; height: 100%;
    object-fit: cover;
    border: 1px solid var(--carta-dark);
  }
  .img-placeholder-lg {
    display: flex; align-items: center; justify-content: center;
    background: var(--carta-dark);
    font-size: 28px;
  }
  .img-upload-hint {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.5);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    opacity: 0;
    transition: opacity 0.2s;
    font-family: 'DM Mono', monospace;
    text-align: center;
    padding: 4px;
  }
  .prodotto-img-wrap:hover .img-upload-hint { opacity: 1; }
  .prodotto-info { flex: 1; min-width: 0; }
  .prodotto-name {
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    font-size: 15px;
    margin-bottom: 2px;
  }
  .prodotto-categoria {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--oro);
    margin-bottom: 4px;
  }
  .prodotto-um {
    font-size: 12px;
    color: var(--grigio);
    font-style: italic;
  }
  .prodotto-ricette {
    font-size: 11px;
    color: var(--verde);
    margin-top: 4px;
  }
  .prodotto-actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }

  /* ===== BADGE ===== */
  .badge {
    display: inline-block;
    padding: 2px 8px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .badge-cat {
    background: var(--carta-dark);
    color: var(--grigio);
  }

  /* ===== ANALISI ===== */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }
  .stat-box {
    background: var(--bianco);
    border: 1px solid var(--carta-dark);
    padding: 24px;
    text-align: center;
    border-top: 4px solid var(--rosso);
  }
  .stat-value {
    font-family: 'Playfair Display', serif;
    font-size: 36px;
    font-weight: 900;
    color: var(--inchiostro);
  }
  .stat-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--grigio);
    margin-top: 4px;
  }
  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }
  .chart-wrap {
    background: var(--bianco);
    border: 1px solid var(--carta-dark);
    padding: 24px;
    box-shadow: 0 2px 8px var(--ombra);
  }
  .chart-wrap h3 {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    margin-bottom: 16px;
    color: var(--inchiostro);
  }
  .chart-container {
    position: relative;
    height: 260px;
    width: 100%;
  }
  @media (max-width: 700px) { .charts-grid { grid-template-columns: 1fr; } }

  /* ===== ARCHIVIO ===== */
  .archivio-item {
    background: var(--bianco);
    border: 1px solid var(--carta-dark);
    margin-bottom: 12px;
    overflow: hidden;
  }
  .archivio-header {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
  }
  .archivio-header:hover { background: var(--carta); }
  .archivio-date {
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    font-size: 16px;
  }
  .archivio-meta {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--grigio);
    margin-top: 2px;
  }
  .archivio-totale {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--rosso);
  }
  .archivio-body {
    display: none;
    padding: 0 20px 20px;
    border-top: 1px solid var(--carta-dark);
  }
  .archivio-body.open { display: block; }

  /* ===== DATE FILTER ===== */
  .date-filter {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
    margin-bottom: 24px;
    padding: 20px;
    background: var(--bianco);
    border: 1px solid var(--carta-dark);
  }

  /* ===== MODAL ===== */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(26,16,8,0.7);
    z-index: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    display: none;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bianco);
    padding: 36px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    border: 2px solid var(--inchiostro);
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    position: relative;
  }
  .modal-title {
    font-family: 'Playfair Display', serif;
    font-size: 24px;
    font-weight: 900;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--inchiostro);
  }
  .modal-close {
    position: absolute;
    top: 16px; right: 16px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--grigio);
    line-height: 1;
    padding: 4px 8px;
  }
  .modal-close:hover { color: var(--rosso); }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    bottom: 32px; right: 32px;
    background: var(--inchiostro);
    color: var(--carta);
    padding: 14px 24px;
    font-family: 'Libre Baskerville', serif;
    font-size: 14px;
    z-index: 9999;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
    border-left: 4px solid var(--oro);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* ===== RICETTE LINK ===== */
  .ricetta-tag {
    display: inline-block;
    background: rgba(45,90,39,0.1);
    color: var(--verde);
    border: 1px solid rgba(45,90,39,0.3);
    padding: 2px 8px;
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.5px;
    margin: 2px;
  }

  /* ===== QUICK ADD in ACQUISTI ===== */
  .quick-prodotto-select {
    display: grid;
    grid-template-columns: 1fr auto auto auto auto;
    gap: 10px;
    align-items: end;
    padding: 20px;
    background: rgba(184,134,11,0.05);
    border: 1px dashed var(--oro);
    margin-bottom: 8px;
  }

  .table-responsive { overflow-x: auto; }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--grigio);
    font-style: italic;
  }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }

  input[type="file"] { display: none; }

  .settimana-badge {
    background: var(--rosso);
    color: white;
    padding: 4px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .divider {
    border: none;
    border-top: 1px solid var(--carta-dark);
    margin: 24px 0;
  }

  .categoria-header {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--oro);
    padding: 8px 0 4px;
    border-bottom: 1px solid var(--carta-dark);
    margin-bottom: 8px;
    margin-top: 16px;
  }

  @media (max-width: 768px) {
    header { padding: 0 16px; }
    nav button { padding: 6px 10px; font-size: 11px; }
    main { padding: 24px 16px; }
    .quick-prodotto-select { grid-template-columns: 1fr 1fr; }
    .form-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">Gestionale Fornitori</div>
    <div class="login-title">Osteria<br>La Sol Fa</div>
    <div class="login-sub">Via Germano Sommeiller 19 ‚Äî Roma</div>
    <input type="password" id="pwd-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="10" autocomplete="off">
    <button class="login-btn" onclick="doLogin()">Entra</button>
    <div class="login-error" id="login-err"></div>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app">
  <header>
    <div class="header-brand">
      Osteria La Sol Fa
      <span>Gestionale Acquisti Conad</span>
    </div>
    <nav>
      <button class="active" onclick="showPage('acquisti', this)">üìã Acquisti</button>
      <button onclick="showPage('prodotti', this)">üì¶ Prodotti</button>
      <button onclick="showPage('analisi', this)">üìä Analisi</button>
      <button onclick="showPage('archivio', this)">üóÑÔ∏è Archivio</button>
    </nav>
    <button class="logout-btn" onclick="doLogout()">Esci</button>
  </header>

  <main>

    <!-- ===== PAGINA ACQUISTI ===== -->
    <div class="page active" id="page-acquisti">
      <div class="section-header">
        <div class="section-title">
          <small>Lista Corrente</small>
          Acquisti
        </div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <div id="settimana-label" class="settimana-badge"></div>
          <button class="btn btn-gold" onclick="exportExcel()">‚¨á Scarica Excel</button>
          <button class="btn btn-outline btn-sm" onclick="archivia()" title="Chiudi periodo e archivia">üóÑ Archivia</button>
        </div>
      </div>

      <!-- Quick Add -->
      <div class="card">
        <div class="card-title">Aggiungi Acquisto</div>
        <div class="quick-prodotto-select">
          <div class="form-group">
            <label>Prodotto</label>
            <input type="text" id="qa-prodotto-text" placeholder="Scrivi il prodotto‚Ä¶" list="qa-prodotto-list" autocomplete="off">
            <datalist id="qa-prodotto-list"></datalist>
          </div>
          <div class="form-group">
            <label>Quantit√†</label>
            <input type="number" id="qa-qty" min="1" step="1" value="1" style="width:80px">
          </div>
          <div class="form-group">
            <label>Prezzo Unit. (‚Ç¨)</label>
            <input type="number" id="qa-prezzo" min="0" step="0.01" placeholder="0.00" style="width:100px">
          </div>
          <div class="form-group">
            <label>Data</label>
            <input type="date" id="qa-data" style="width:150px">
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="addAcquisto()">Ôºã Aggiungi</button>
          </div>
        </div>
      </div>

      <!-- Tabella acquisti -->
      <div class="card" style="padding:0;overflow:hidden;">
        <div class="table-responsive">
          <table class="acquisti-table" id="acquisti-table">
            <thead>
              <tr>
                <th></th>
                <th>Prodotto</th>
                <th>Categoria</th>
                <th>Qt√†</th>
                <th>U.M.</th>
                <th>Prezzo Unit.</th>
                <th>Totale</th>
                <th>Data</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="acquisti-tbody"></tbody>
          </table>
        </div>
        <div class="totale-bar">
          <span class="totale-label">Totale Periodo</span>
          <span class="totale-value" id="totale-display">‚Ç¨ 0,00</span>
        </div>
      </div>
    </div>

    <!-- ===== PAGINA PRODOTTI ===== -->
    <div class="page" id="page-prodotti">
      <div class="section-header">
        <div class="section-title">
          <small>Catalogo</small>
          Prodotti
        </div>
        <button class="btn btn-primary" onclick="openModalNuovoProdotto()">Ôºã Nuovo Prodotto</button>
      </div>

      <!-- Filtro categorie -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;">
        <button class="btn btn-sm btn-primary" onclick="filterCategoria('all')">Tutti</button>
        <button class="btn btn-sm btn-outline" onclick="filterCategoria('Latticini')">Latticini</button>
        <button class="btn btn-sm btn-outline" onclick="filterCategoria('Carni')">Carni</button>
        <button class="btn btn-sm btn-outline" onclick="filterCategoria('Conserve')">Conserve</button>
        <button class="btn btn-sm btn-outline" onclick="filterCategoria('Farine & Pasta')">Farine</button>
        <button class="btn btn-sm btn-outline" onclick="filterCategoria('Grassi & Oli')">Oli</button>
        <button class="btn btn-sm btn-outline" onclick="filterCategoria('Spezie & Condimenti')">Spezie</button>
        <button class="btn btn-sm btn-outline" onclick="filterCategoria('Dolciumi')">Dolciumi</button>
        <button class="btn btn-sm btn-outline" onclick="filterCategoria('Altro')">Altro</button>
      </div>

      <div class="prodotti-grid" id="prodotti-grid"></div>
    </div>

    <!-- ===== PAGINA ANALISI ===== -->
    <div class="page" id="page-analisi">
      <div class="section-header">
        <div class="section-title">
          <small>Report</small>
          Analisi Spese
        </div>
      </div>

      <!-- Filtro periodo -->
      <div class="date-filter">
        <div class="form-group">
          <label>Dal</label>
          <input type="date" id="analisi-dal">
        </div>
        <div class="form-group">
          <label>Al</label>
          <input type="date" id="analisi-al">
        </div>
        <button class="btn btn-primary" onclick="aggiornaAnalisi()">Analizza</button>
        <button class="btn btn-outline btn-sm" onclick="setAnalisiPreset('settimana')">Questa settimana</button>
        <button class="btn btn-outline btn-sm" onclick="setAnalisiPreset('mese')">Questo mese</button>
        <button class="btn btn-outline btn-sm" onclick="setAnalisiPreset('tutto')">Tutto</button>
      </div>

      <!-- Stat boxes -->
      <div class="stats-grid" id="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="stat-totale">‚Ç¨0</div>
          <div class="stat-label">Spesa Totale</div>
        </div>
        <div class="stat-box" style="border-top-color: var(--oro)">
          <div class="stat-value" id="stat-nrighe">0</div>
          <div class="stat-label">Acquisti</div>
        </div>
        <div class="stat-box" style="border-top-color: var(--verde)">
          <div class="stat-value" id="stat-media">‚Ç¨0</div>
          <div class="stat-label">Spesa Media</div>
        </div>
        <div class="stat-box" style="border-top-color: var(--grigio)">
          <div class="stat-value" id="stat-top">‚Äî</div>
          <div class="stat-label">Prodotto Top</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-wrap">
          <h3>Spesa per Categoria</h3>
          <div class="chart-container"><canvas id="chart-categorie"></canvas></div>
        </div>
        <div class="chart-wrap">
          <h3>Trend Acquisti nel Tempo</h3>
          <div class="chart-container"><canvas id="chart-trend"></canvas></div>
        </div>
        <div class="chart-wrap">
          <h3>Top 10 Prodotti (spesa)</h3>
          <div class="chart-container"><canvas id="chart-prodotti-top"></canvas></div>
        </div>
        <div class="chart-wrap">
          <h3>Distribuzione Mensile</h3>
          <div class="chart-container"><canvas id="chart-mensile"></canvas></div>
        </div>
      </div>

      <!-- Tabella riassuntiva per ricette -->
      <div class="card">
        <div class="card-title">Ingredienti per Ricetta</div>
        <div id="ricette-riepilogo"></div>
      </div>
    </div>

    <!-- ===== PAGINA ARCHIVIO ===== -->
    <div class="page" id="page-archivio">
      <div class="section-header">
        <div class="section-title">
          <small>Storico</small>
          Archivio
        </div>
        <button class="btn btn-gold btn-sm" onclick="exportArchivioExcel()">‚¨á Export Archivio</button>
      </div>

      <!-- Filtri archivio -->
      <div class="date-filter" style="margin-bottom:20px;">
        <div class="form-group">
          <label>Cerca prodotto</label>
          <input type="text" id="archivio-search" placeholder="es. Pecorino‚Ä¶" style="width:180px" oninput="renderArchivio()">
        </div>
        <div class="form-group">
          <label>Categoria</label>
          <select id="archivio-cat" onchange="renderArchivio()" style="width:160px">
            <option value="">Tutte</option>
          </select>
        </div>
        <div class="form-group">
          <label>Dal</label>
          <input type="date" id="archivio-dal" onchange="renderArchivio()" style="width:150px">
        </div>
        <div class="form-group">
          <label>Al</label>
          <input type="date" id="archivio-al" onchange="renderArchivio()" style="width:150px">
        </div>
        <button class="btn btn-outline btn-sm" onclick="resetArchivioFiltri()">‚úï Reset</button>
      </div>

      <div id="archivio-list"></div>
    </div>

  </main>
</div>

<!-- ===== MODAL PRODOTTO ===== -->
<div class="modal-overlay" id="modal-prodotto">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-prodotto')">√ó</button>
    <div class="modal-title" id="modal-prodotto-title">Nuovo Prodotto</div>
    <div class="form-grid" style="grid-template-columns:1fr 1fr;margin-bottom:16px;">
      <div class="form-group" style="grid-column:1/-1;">
        <label>Nome Prodotto *</label>
        <input type="text" id="p-nome" placeholder="es. Pecorino Romano">
      </div>
      <div class="form-group">
        <label>Categoria</label>
        <select id="p-categoria" onchange="handleCatChange(this)">
          <option>Latticini</option>
          <option>Carni</option>
          <option>Conserve</option>
          <option>Farine & Pasta</option>
          <option>Grassi & Oli</option>
          <option>Spezie & Condimenti</option>
          <option>Dolciumi</option>
          <option>Altro</option>
          <option value="__nuova__">Ôºã Nuova categoria‚Ä¶</option>
        </select>
        <input type="text" id="p-categoria-custom" placeholder="Nome nuova categoria" style="display:none;margin-top:6px;">
      </div>
      <div class="form-group">
        <label>Unit√† di Misura</label>
        <select id="p-um">
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="L">L</option>
          <option value="pz">pz</option>
          <option value="conf">conf</option>
          <option value="busta">busta</option>
          <option value="bottiglia">bottiglia</option>
          <option value="lattina">lattina</option>
        </select>
      </div>
      <div class="form-group">
        <label>Prezzo Stimato (‚Ç¨)</label>
        <input type="number" id="p-prezzo-stima" step="0.01" placeholder="0.00">
      </div>
      <div class="form-group" style="grid-column:1/-1;">
        <label>Ricette Collegate (separate da virgola)</label>
        <input type="text" id="p-ricette" placeholder="es. Carbonara, Gricia, Cacio e Pepe">
      </div>
      <div class="form-group" style="grid-column:1/-1;">
        <label>Note</label>
        <textarea id="p-note" rows="2" placeholder="Note opzionali‚Ä¶" style="resize:vertical;"></textarea>
      </div>
    </div>
    <input type="hidden" id="p-editing-id">
    <div style="display:flex;gap:12px;">
      <button class="btn btn-primary" onclick="saveProdotto()">Salva Prodotto</button>
      <button class="btn btn-outline" onclick="closeModal('modal-prodotto')">Annulla</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// DATA LAYER ‚Äî localStorage
// ============================================================
const KEY_PROD = 'solfa_prodotti';
const KEY_ACQ  = 'solfa_acquisti';
const KEY_ARCH = 'solfa_archivio';
const KEY_IMG  = 'solfa_immagini'; // prodottoId -> base64

let prodotti   = JSON.parse(localStorage.getItem(KEY_PROD) || '[]');
let acquisti   = JSON.parse(localStorage.getItem(KEY_ACQ)  || '[]');
let archivio   = JSON.parse(localStorage.getItem(KEY_ARCH) || '[]');
let immagini   = JSON.parse(localStorage.getItem(KEY_IMG)  || '{}');

function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
function saveProdotti() { save(KEY_PROD, prodotti); }
function saveAcquisti() { save(KEY_ACQ, acquisti); }
function saveArchivio() { save(KEY_ARCH, archivio); }
function saveImmagini() { save(KEY_IMG, immagini); }

// ============================================================
// DATI INIZIALI ‚Äî ~20 prodotti se il db √® vuoto
// ============================================================
const prodottiDefault = [
  {id:'p001', nome:'Pecorino Romano',        categoria:'Latticini',           um:'kg',       prezzoStima:28.00, ricette:'Carbonara, Gricia, Cacio e Pepe, Matriciana', note:'Privo di lattosio'},
  {id:'p002', nome:'Guanciale',              categoria:'Carni',               um:'kg',       prezzoStima:18.00, ricette:'Carbonara, Matriciana, Gricia', note:''},
  {id:'p003', nome:'Parmigiano Reggiano',    categoria:'Latticini',           um:'kg',       prezzoStima:30.00, ricette:'Polpette al forno', note:''},
  {id:'p004', nome:'Mascarpone',             categoria:'Latticini',           um:'kg',       prezzoStima:9.50,  ricette:'Tiramis√π', note:'Senza lattosio'},
  {id:'p005', nome:'Burro senza lattosio',   categoria:'Latticini',           um:'pz',       prezzoStima:3.20,  ricette:'Torta di mele, Tiramis√π', note:'250g a confezione'},
  {id:'p006', nome:'Uova pastorizzate',      categoria:'Altro',               um:'pz',       prezzoStima:0.30,  ricette:'Carbonara, Tiramis√π, Polpette, Torta di mele', note:''},
  {id:'p007', nome:'Pomodori pelati',        categoria:'Conserve',            um:'lattina',  prezzoStima:1.40,  ricette:'Matriciana, Trippa alla romana, Coda alla vaccinara', note:'400g'},
  {id:'p008', nome:'Olio EVO',               categoria:'Grassi & Oli',        um:'L',        prezzoStima:12.00, ricette:'Tutti i secondi, Trippa, Coda, Spezzatino', note:'Laziale'},
  {id:'p009', nome:'Farina 00',              categoria:'Farine & Pasta',      um:'kg',       prezzoStima:1.20,  ricette:'Torta di mele', note:''},
  {id:'p010', nome:"Tagliolini freschi all'uovo", categoria:'Farine & Pasta', um:'kg',       prezzoStima:5.50,  ricette:'Carbonara, Gricia, Cacio e Pepe', note:'Pasta fresca'},
  {id:'p011', nome:"Tagliatelle fresche all'uovo", categoria:'Farine & Pasta',um:'kg',       prezzoStima:5.50,  ricette:'Matriciana', note:''},
  {id:'p012', nome:'Pepe nero in grani',     categoria:'Spezie & Condimenti', um:'busta',    prezzoStima:2.80,  ricette:'Cacio e Pepe, Carbonara, Gricia', note:'Macinato al momento'},
  {id:'p013', nome:'Sale fino',              categoria:'Spezie & Condimenti', um:'kg',       prezzoStima:0.80,  ricette:'Tutte le ricette', note:''},
  {id:'p014', nome:'Vino bianco secco',      categoria:'Altro',               um:'bottiglia',prezzoStima:4.00,  ricette:'Polpette, Spezzatino, Trippa, Baccal√†', note:''},
  {id:'p015', nome:'Vino rosso',             categoria:'Altro',               um:'bottiglia',prezzoStima:5.00,  ricette:'Coda alla vaccinara', note:''},
  {id:'p016', nome:'Caff√® macinato',         categoria:'Altro',               um:'busta',    prezzoStima:4.50,  ricette:'Tiramis√π', note:'200g'},
  {id:'p017', nome:'Zucchero a velo',        categoria:'Dolciumi',            um:'busta',    prezzoStima:1.80,  ricette:'Tiramis√π', note:''},
  {id:'p018', nome:'Cacao amaro in polvere', categoria:'Dolciumi',            um:'busta',    prezzoStima:3.20,  ricette:'Tiramis√π', note:''},
  {id:'p019', nome:'Noce moscata',           categoria:'Spezie & Condimenti', um:'pz',       prezzoStima:2.50,  ricette:'Polpette al forno', note:'Intera'},
  {id:'p020', nome:'Panna da cucina senza lattosio', categoria:'Latticini',   um:'conf',     prezzoStima:2.20,  ricette:'Tiramis√π', note:'200ml'},
  {id:'p021', nome:'Aceto di vino bianco',   categoria:'Spezie & Condimenti', um:'bottiglia',prezzoStima:2.00,  ricette:'Polpette, Baccal√†', note:''},
  {id:'p022', nome:'Cipolla rossa',          categoria:'Altro',               um:'kg',       prezzoStima:1.50,  ricette:'Matriciana, Trippa, Coda alla vaccinara', note:''},
];

if (prodotti.length === 0) {
  prodotti = prodottiDefault;
  saveProdotti();
}

// ============================================================
// LOGIN
// ============================================================
const PWD = '1234';

document.getElementById('pwd-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});

function doLogin() {
  const v = document.getElementById('pwd-input').value;
  if (v === PWD) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initApp();
  } else {
    const err = document.getElementById('login-err');
    err.textContent = 'Password errata. Riprova.';
    document.getElementById('pwd-input').value = '';
    setTimeout(() => err.textContent = '', 2000);
  }
}

function doLogout() {
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('pwd-input').value = '';
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if (btn) btn.classList.add('active');
  if (id === 'analisi') { setTimeout(aggiornaAnalisi, 100); }
  if (id === 'archivio') renderArchivio();
  if (id === 'prodotti') renderProdotti();
}

// ============================================================
// INIT
// ============================================================
function initApp() {
  impostaDataOggi();
  renderSelectProdotti();
  renderAcquisti();
  renderProdotti();
  aggiornaSectionBadge();
}

function impostaDataOggi() {
  const oggi = new Date().toISOString().split('T')[0];
  document.getElementById('qa-data').value = oggi;
}

function aggiornaSectionBadge() {
  const ora = new Date();
  const lun = getMonday(ora);
  const dom = new Date(lun); dom.setDate(dom.getDate() + 6);
  document.getElementById('settimana-label').textContent =
    `Settimana ${formatData(lun)} ‚Äî ${formatData(dom)}`;
}

function getMonday(d) {
  const date = new Date(d);
  const day = date.getDay();
  const diff = date.getDate() - day + (day === 0 ? -6 : 1);
  date.setDate(diff);
  return date;
}

function formatData(d) {
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${dd}/${mm}`;
}
function formatDataFull(str) {
  if (!str) return '';
  const [y,m,d] = str.split('-');
  return `${d}/${m}/${y}`;
}
function formatEur(n) {
  return '‚Ç¨ ' + Number(n).toFixed(2).replace('.',',');
}

// ============================================================
// SELECT / DATALIST PRODOTTI
// ============================================================
function renderSelectProdotti() {
  const dl = document.getElementById('qa-prodotto-list');
  if (!dl) return;
  dl.innerHTML = '';
  prodotti.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.nome;
    opt.setAttribute('data-id', p.id);
    dl.appendChild(opt);
  });

  // precompila prezzo quando si sceglie un prodotto del catalogo
  const input = document.getElementById('qa-prodotto-text');
  if (input) {
    input.addEventListener('input', () => {
      const val = input.value.trim();
      const prod = prodotti.find(p => p.nome.toLowerCase() === val.toLowerCase());
      if (prod && prod.prezzoStima) {
        document.getElementById('qa-prezzo').value = prod.prezzoStima;
      }
    });
  }
}

// ============================================================
// ACQUISTI
// ============================================================
function addAcquisto() {
  const nomeScritto = document.getElementById('qa-prodotto-text').value.trim();
  const qty    = parseInt(document.getElementById('qa-qty').value) || 1;
  const prezzo = parseFloat(document.getElementById('qa-prezzo').value);
  const data   = document.getElementById('qa-data').value;

  if (!nomeScritto) { showToast('Scrivi il nome del prodotto'); return; }
  if (!prezzo || isNaN(prezzo)) { showToast('Inserisci il prezzo'); return; }

  // cerca nel catalogo per categoria/um, altrimenti usa valori di default
  const prod = prodotti.find(p => p.nome.toLowerCase() === nomeScritto.toLowerCase());
  const acq = {
    id: 'a' + Date.now(),
    prodottoId: prod ? prod.id : 'custom_' + nomeScritto,
    prodottoNome: prod ? prod.nome : nomeScritto,
    categoria: prod ? prod.categoria : 'Altro',
    um: prod ? prod.um : 'pz',
    qty,
    prezzoUnit: prezzo,
    totale: qty * prezzo,
    data
  };
  acquisti.push(acq);
  saveAcquisti();
  renderAcquisti();
  showToast(`${acq.prodottoNome} aggiunto ‚Äî ${formatEur(acq.totale)}`);

  // reset
  document.getElementById('qa-qty').value = 1;
  document.getElementById('qa-prodotto-text').value = '';
  document.getElementById('qa-prezzo').value = '';
}

function deleteAcquisto(id) {
  acquisti = acquisti.filter(a => a.id !== id);
  saveAcquisti();
  renderAcquisti();
}

function renderAcquisti() {
  const tbody = document.getElementById('acquisti-tbody');
  tbody.innerHTML = '';

  if (acquisti.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" class="empty-state"><div class="icon">üßæ</div>Nessun acquisto ancora. Usa il form sopra per aggiungere.</td></tr>`;
    document.getElementById('totale-display').textContent = '‚Ç¨ 0,00';
    return;
  }

  const sorted = [...acquisti].sort((a,b) => (b.data||'').localeCompare(a.data||''));
  let totale = 0;

  sorted.forEach(a => {
    totale += a.totale;
    const img = immagini[a.prodottoId];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${img
        ? `<img src="${img}" class="prodotto-img" alt="">`
        : `<div class="img-placeholder">üõí</div>`
      }</td>
      <td><strong>${a.prodottoNome}</strong></td>
      <td><span class="badge badge-cat">${a.categoria}</span></td>
      <td>${a.qty}</td>
      <td>${a.um}</td>
      <td>${formatEur(a.prezzoUnit)}</td>
      <td><strong>${formatEur(a.totale)}</strong></td>
      <td>${formatDataFull(a.data)}</td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteAcquisto('${a.id}')">‚úï</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('totale-display').textContent = formatEur(totale);
}

// ============================================================
// ARCHIVIO / ARCHIVIA
// ============================================================
function archivia() {
  if (acquisti.length === 0) { showToast('Nessun acquisto da archiviare'); return; }
  if (!confirm('Vuoi archiviare gli acquisti correnti e azzerare la lista?')) return;

  const periodo = {
    id: 'arch' + Date.now(),
    data: new Date().toISOString().split('T')[0],
    acquisti: JSON.parse(JSON.stringify(acquisti)),
    totale: acquisti.reduce((s,a) => s+a.totale, 0)
  };
  archivio.unshift(periodo);
  saveArchivio();
  acquisti = [];
  saveAcquisti();
  renderAcquisti();
  renderArchivio();
  showToast('Periodo archiviato con successo!');
}

function resetArchivioFiltri() {
  document.getElementById('archivio-search').value = '';
  document.getElementById('archivio-cat').value = '';
  document.getElementById('archivio-dal').value = '';
  document.getElementById('archivio-al').value = '';
  renderArchivio();
}

function aggiornaCategorieArchivioSelect() {
  const sel = document.getElementById('archivio-cat');
  if (!sel) return;
  const cats = [...new Set([...acquisti, ...archivio.flatMap(p => p.acquisti)].map(a => a.categoria))].sort();
  sel.innerHTML = '<option value="">Tutte</option>';
  cats.forEach(c => {
    const o = document.createElement('option');
    o.value = c; o.textContent = c;
    sel.appendChild(o);
  });
}

function renderArchivio() {
  aggiornaCategorieArchivioSelect();
  const container = document.getElementById('archivio-list');
  const search  = (document.getElementById('archivio-search')?.value || '').toLowerCase();
  const catFilt = document.getElementById('archivio-cat')?.value || '';
  const dal     = document.getElementById('archivio-dal')?.value || '';
  const al      = document.getElementById('archivio-al')?.value || '';

  // Combina archivio + acquisti correnti
  const tutti = [];
  if (acquisti.length > 0) {
    tutti.push({ id:'corrente', data: new Date().toISOString().split('T')[0], acquisti, totale: acquisti.reduce((s,a)=>s+a.totale,0), corrente:true });
  }
  tutti.push(...archivio);

  if (tutti.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="icon">üóÑÔ∏è</div>Nessun archivio ancora.</div>`;
    return;
  }

  container.innerHTML = '';
  let totaleGlobale = 0;
  let righeGlobali = 0;

  tutti.forEach(p => {
    let filtrati = p.acquisti;
    if (search)  filtrati = filtrati.filter(a => a.prodottoNome.toLowerCase().includes(search));
    if (catFilt) filtrati = filtrati.filter(a => a.categoria === catFilt);
    if (dal)     filtrati = filtrati.filter(a => a.data >= dal);
    if (al)      filtrati = filtrati.filter(a => a.data <= al);

    // Nascondi periodi senza risultati se ci sono filtri attivi
    if (filtrati.length === 0 && (search || catFilt || dal || al)) return;

    const filteredTotal = filtrati.reduce((s,a) => s+a.totale, 0);
    totaleGlobale += filteredTotal;
    righeGlobali  += filtrati.length;

    const dataLabel = p.corrente ? 'üìå Periodo Corrente' : `Periodo archiviato il ${formatDataFull(p.data)}`;
    const item = document.createElement('div');
    item.className = 'archivio-item';
    item.innerHTML = `
      <div class="archivio-header" onclick="toggleArchivio(this)">
        <div>
          <div class="archivio-date">${dataLabel}</div>
          <div class="archivio-meta">${filtrati.length} acquisti${(search||catFilt||dal||al) ? ' (filtrati)' : ''}</div>
        </div>
        <div style="display:flex;align-items:center;gap:16px;">
          <div class="archivio-totale">${formatEur(filteredTotal)}</div>
          <span style="font-size:20px;color:var(--grigio);">‚ñæ</span>
        </div>
      </div>
      <div class="archivio-body">
        ${filtrati.length === 0
          ? '<div class="empty-state" style="padding:20px;">Nessun prodotto trovato.</div>'
          : renderMiniTable(filtrati)
        }
        ${!p.corrente ? `<div style="margin-top:12px;"><button class="btn btn-danger btn-sm" onclick="deleteArchivio('${p.id}')">üóë Elimina periodo</button></div>` : ''}
      </div>
    `;
    container.appendChild(item);
  });

  // Totale filtrato in fondo
  if (righeGlobali > 0 && (search || catFilt || dal || al)) {
    const summary = document.createElement('div');
    summary.style.cssText = 'background:var(--inchiostro);color:var(--carta);padding:16px 20px;display:flex;justify-content:space-between;align-items:center;margin-top:8px;';
    summary.innerHTML = `
      <span style="font-family:DM Mono,monospace;font-size:11px;letter-spacing:2px;color:rgba(255,255,255,0.6);">TOTALE FILTRATO ‚Äî ${righeGlobali} righe</span>
      <span style="font-family:Playfair Display,serif;font-size:24px;font-weight:900;color:var(--oro);">${formatEur(totaleGlobale)}</span>
    `;
    container.appendChild(summary);
  }
}

function renderMiniTable(acqs) {
  const rows = [...acqs].sort((a,b)=>(b.data||'').localeCompare(a.data||'')).map(a =>
    `<tr>
      <td>${formatDataFull(a.data)}</td>
      <td>${a.prodottoNome}</td>
      <td><span class="badge badge-cat">${a.categoria}</span></td>
      <td>${a.qty} ${a.um}</td>
      <td>${formatEur(a.prezzoUnit)}</td>
      <td><strong>${formatEur(a.totale)}</strong></td>
    </tr>`
  ).join('');
  return `<table class="acquisti-table" style="margin-top:12px;">
    <thead><tr>
      <th>Data</th><th>Prodotto</th><th>Cat.</th><th>Qt√†</th><th>P.Unit</th><th>Totale</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function toggleArchivio(header) {
  const body = header.nextElementSibling;
  body.classList.toggle('open');
}

function deleteArchivio(id) {
  if (!confirm('Eliminare questo periodo dall\'archivio?')) return;
  archivio = archivio.filter(a => a.id !== id);
  saveArchivio();
  renderArchivio();
  showToast('Periodo eliminato');
}

// ============================================================
// PRODOTTI
// ============================================================
let filtroCategoria = 'all';

function filterCategoria(cat) {
  filtroCategoria = cat;
  document.querySelectorAll('#page-prodotti .btn-sm').forEach(b => {
    b.className = b.textContent.trim().toLowerCase().includes(cat.toLowerCase()) || (cat === 'all' && b.textContent.trim() === 'Tutti')
      ? 'btn btn-sm btn-primary'
      : 'btn btn-sm btn-outline';
  });
  renderProdotti();
}

function renderProdotti() {
  const grid = document.getElementById('prodotti-grid');
  const list = filtroCategoria === 'all'
    ? prodotti
    : prodotti.filter(p => p.categoria === filtroCategoria);

  if (list.length === 0) {
    grid.innerHTML = `<div class="empty-state"><div class="icon">üì¶</div>Nessun prodotto in questa categoria.</div>`;
    return;
  }
  grid.innerHTML = '';

  list.forEach(p => {
    const img = immagini[p.id];
    const ricette = p.ricette
      ? p.ricette.split(',').map(r => `<span class="ricetta-tag">${r.trim()}</span>`).join('')
      : '';

    const card = document.createElement('div');
    card.className = 'prodotto-card';
    card.innerHTML = `
      <div class="prodotto-img-wrap" onclick="uploadImmagine('${p.id}')">
        ${img
          ? `<img src="${img}" alt="${p.nome}">`
          : `<div class="img-placeholder-lg">ü•ò</div>`
        }
        <div class="img-upload-hint">üì∑ Cambia foto</div>
        <input type="file" accept="image/*" id="img-input-${p.id}" onchange="handleImgUpload(event,'${p.id}')">
      </div>
      <div class="prodotto-info">
        <div class="prodotto-categoria">${p.categoria}</div>
        <div class="prodotto-name">${p.nome}</div>
        <div class="prodotto-um">Unit√†: ${p.um}${p.prezzoStima ? ` ¬∑ Stima: ${formatEur(p.prezzoStima)}` : ''}</div>
        ${ricette ? `<div class="prodotto-ricette">${ricette}</div>` : ''}
        ${p.note ? `<div style="font-size:11px;color:var(--grigio);font-style:italic;margin-top:4px;">${p.note}</div>` : ''}
        <div class="prodotto-actions">
          <button class="btn btn-outline btn-sm" onclick="editProdotto('${p.id}')">‚úè Modifica</button>
          <button class="btn btn-danger btn-sm" onclick="deleteProdotto('${p.id}')">‚úï</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
}

function uploadImmagine(pid) {
  document.getElementById(`img-input-${pid}`).click();
}

function handleImgUpload(event, pid) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    immagini[pid] = e.target.result;
    saveImmagini();
    renderProdotti();
    renderSelectProdotti();
    showToast('Immagine caricata!');
  };
  reader.readAsDataURL(file);
}

function handleCatChange(sel) {
  const custom = document.getElementById('p-categoria-custom');
  if (sel.value === '__nuova__') {
    custom.style.display = 'block';
    custom.focus();
  } else {
    custom.style.display = 'none';
  }
}

let editingProdottoId = null;

function openModalNuovoProdotto() {
  editingProdottoId = null;
  document.getElementById('modal-prodotto-title').textContent = 'Nuovo Prodotto';
  document.getElementById('p-nome').value = '';
  document.getElementById('p-categoria').value = 'Latticini';
  document.getElementById('p-categoria-custom').style.display = 'none';
  document.getElementById('p-categoria-custom').value = '';
  document.getElementById('p-um').value = 'kg';
  document.getElementById('p-prezzo-stima').value = '';
  document.getElementById('p-ricette').value = '';
  document.getElementById('p-note').value = '';
  document.getElementById('modal-prodotto').classList.add('open');
}

function editProdotto(id) {
  const p = prodotti.find(x => x.id === id);
  if (!p) return;
  editingProdottoId = id;
  document.getElementById('modal-prodotto-title').textContent = 'Modifica Prodotto';
  document.getElementById('p-nome').value = p.nome;
  // se la categoria non √® nel select standard, aggiungila
  aggiungiCategoriaAlSelect(p.categoria);
  document.getElementById('p-categoria').value = p.categoria;
  document.getElementById('p-categoria-custom').style.display = 'none';
  document.getElementById('p-um').value = p.um;
  document.getElementById('p-prezzo-stima').value = p.prezzoStima || '';
  document.getElementById('p-ricette').value = p.ricette || '';
  document.getElementById('p-note').value = p.note || '';
  document.getElementById('modal-prodotto').classList.add('open');
}

function saveProdotto() {
  const nome = document.getElementById('p-nome').value.trim();
  if (!nome) { showToast('Inserisci il nome del prodotto'); return; }

  let categoria = document.getElementById('p-categoria').value;
  if (categoria === '__nuova__') {
    categoria = document.getElementById('p-categoria-custom').value.trim();
    if (!categoria) { showToast('Inserisci il nome della nuova categoria'); return; }
    // Aggiungi la nuova categoria al select se non esiste gi√†
    aggiungiCategoriaAlSelect(categoria);
  }

  const dati = {
    nome,
    categoria,
    um: document.getElementById('p-um').value,
    prezzoStima: parseFloat(document.getElementById('p-prezzo-stima').value) || 0,
    ricette: document.getElementById('p-ricette').value.trim(),
    note: document.getElementById('p-note').value.trim()
  };

  if (editingProdottoId) {
    const idx = prodotti.findIndex(p => p.id === editingProdottoId);
    prodotti[idx] = { ...prodotti[idx], ...dati };
    showToast('Prodotto aggiornato!');
  } else {
    prodotti.push({ id: 'p' + Date.now(), ...dati });
    showToast('Prodotto aggiunto!');
  }

  saveProdotti();
  renderProdotti();
  renderSelectProdotti();
  closeModal('modal-prodotto');
}

function aggiungiCategoriaAlSelect(nomeCat) {
  const sel = document.getElementById('p-categoria');
  // controlla se esiste gi√†
  for (const opt of sel.options) {
    if (opt.value === nomeCat) return;
  }
  // inserisci prima dell'opzione "Nuova categoria"
  const nuovaOpt = sel.querySelector('option[value="__nuova__"]');
  const opt = document.createElement('option');
  opt.value = nomeCat; opt.textContent = nomeCat;
  sel.insertBefore(opt, nuovaOpt);
  sel.value = nomeCat;
  document.getElementById('p-categoria-custom').style.display = 'none';
}

function deleteProdotto(id) {
  if (!confirm('Eliminare questo prodotto dal catalogo?')) return;
  prodotti = prodotti.filter(p => p.id !== id);
  saveProdotti();
  delete immagini[id];
  saveImmagini();
  renderProdotti();
  renderSelectProdotti();
  showToast('Prodotto eliminato');
}

// ============================================================
// ANALISI
// ============================================================
let chartCat, chartTrend, chartTop, chartMensile;

function setAnalisiPreset(tipo) {
  const oggi = new Date();
  let dal, al = oggi.toISOString().split('T')[0];
  if (tipo === 'settimana') {
    dal = getMonday(oggi).toISOString().split('T')[0];
  } else if (tipo === 'mese') {
    dal = new Date(oggi.getFullYear(), oggi.getMonth(), 1).toISOString().split('T')[0];
  } else {
    dal = '2020-01-01';
  }
  document.getElementById('analisi-dal').value = dal;
  document.getElementById('analisi-al').value = al;
  aggiornaAnalisi();
}

function aggiornaAnalisi() {
  const dal = document.getElementById('analisi-dal').value;
  const al  = document.getElementById('analisi-al').value;

  // Tutti gli acquisti (correnti + archiviati)
  let tuttiAcq = [...acquisti];
  archivio.forEach(p => tuttiAcq.push(...p.acquisti));

  let filtrati = tuttiAcq;
  if (dal) filtrati = filtrati.filter(a => a.data >= dal);
  if (al)  filtrati = filtrati.filter(a => a.data <= al);

  // Stats
  const totale = filtrati.reduce((s,a) => s+a.totale, 0);
  const media = filtrati.length > 0 ? totale / filtrati.length : 0;

  // Top prodotto
  const perProd = {};
  filtrati.forEach(a => {
    perProd[a.prodottoNome] = (perProd[a.prodottoNome] || 0) + a.totale;
  });
  const topProd = Object.entries(perProd).sort((a,b) => b[1]-a[1])[0];

  document.getElementById('stat-totale').textContent = formatEur(totale);
  document.getElementById('stat-nrighe').textContent = filtrati.length;
  document.getElementById('stat-media').textContent = formatEur(media);
  document.getElementById('stat-top').textContent = topProd ? topProd[0].split(' ')[0] : '‚Äî';

  // Chart 1: per categoria (donut)
  const perCat = {};
  filtrati.forEach(a => { perCat[a.categoria] = (perCat[a.categoria] || 0) + a.totale; });
  const colori = ['#8b1a1a','#b8860b','#2d5a27','#1a4a6b','#6b1a5a','#4a6b1a','#6b4a1a','#1a6b4a'];
  renderChart('chart-categorie', 'doughnut', {
    labels: Object.keys(perCat),
    datasets: [{ data: Object.values(perCat).map(v => v.toFixed(2)), backgroundColor: colori }]
  }, chartCat, c => chartCat = c);

  // Chart 2: trend nel tempo (line)
  const perData = {};
  filtrati.forEach(a => { perData[a.data] = (perData[a.data] || 0) + a.totale; });
  const dateSort = Object.keys(perData).sort();
  renderChart('chart-trend', 'line', {
    labels: dateSort.map(d => formatDataFull(d)),
    datasets: [{
      label: 'Spesa (‚Ç¨)',
      data: dateSort.map(d => perData[d].toFixed(2)),
      borderColor: '#8b1a1a',
      backgroundColor: 'rgba(139,26,26,0.1)',
      tension: 0.3, fill: true
    }]
  }, chartTrend, c => chartTrend = c);

  // Chart 3: top 10 prodotti (bar)
  const top10 = Object.entries(perProd).sort((a,b) => b[1]-a[1]).slice(0,10);
  renderChart('chart-prodotti-top', 'bar', {
    labels: top10.map(e => e[0].length > 18 ? e[0].substring(0,18)+'‚Ä¶' : e[0]),
    datasets: [{
      label: 'Spesa (‚Ç¨)',
      data: top10.map(e => e[1].toFixed(2)),
      backgroundColor: '#b8860b'
    }]
  }, chartTop, c => chartTop = c);

  // Chart 4: distribuzione mensile (bar)
  const perMese = {};
  filtrati.forEach(a => {
    if (!a.data) return;
    const mese = a.data.substring(0,7);
    perMese[mese] = (perMese[mese] || 0) + a.totale;
  });
  const mesiSort = Object.keys(perMese).sort();
  renderChart('chart-mensile', 'bar', {
    labels: mesiSort.map(m => {
      const [y,mo] = m.split('-');
      const nomi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
      return nomi[parseInt(mo)-1] + ' ' + y.substring(2);
    }),
    datasets: [{
      label: 'Totale mensile (‚Ç¨)',
      data: mesiSort.map(m => perMese[m].toFixed(2)),
      backgroundColor: '#2d5a27'
    }]
  }, chartMensile, c => chartMensile = c);

  // Riepilogo per ricette
  renderRicetteRiepilogo(filtrati);
}

function renderChart(canvasId, type, data, existingChart, setter) {
  if (existingChart) existingChart.destroy();
  const ctx = document.getElementById(canvasId);
  if (!ctx) return;
  const chart = new Chart(ctx, {
    type,
    data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { font: { family: 'Libre Baskerville', size: 11 }, color: '#1a1008', boxWidth: 12 } },
        tooltip: { callbacks: { label: ctx => ' ‚Ç¨ ' + parseFloat(ctx.raw).toFixed(2).replace('.',',') } }
      },
      scales: type !== 'doughnut' ? {
        x: { ticks: { font: { family: 'DM Mono', size: 10 }, color: '#6b5d4f', maxRotation: 45 } },
        y: { ticks: { font: { family: 'DM Mono', size: 10 }, color: '#6b5d4f' }, beginAtZero: true }
      } : {}
    }
  });
  setter(chart);
}

function renderRicetteRiepilogo(filtrati) {
  const container = document.getElementById('ricette-riepilogo');
  const ricetteMap = {};
  filtrati.forEach(a => {
    const prod = prodotti.find(p => p.id === a.prodottoId);
    if (!prod || !prod.ricette) return;
    prod.ricette.split(',').forEach(r => {
      r = r.trim();
      if (!ricetteMap[r]) ricetteMap[r] = { prodotti: [], spesa: 0 };
      ricetteMap[r].prodotti.push(a.prodottoNome);
      ricetteMap[r].spesa += a.totale;
    });
  });

  const entries = Object.entries(ricetteMap).sort((a,b) => b[1].spesa - a[1].spesa);
  if (entries.length === 0) {
    container.innerHTML = '<div class="empty-state">Nessun dato disponibile.</div>';
    return;
  }

  container.innerHTML = entries.map(([r, v]) => {
    const unici = [...new Set(v.prodotti)];
    return `<div style="padding:12px 0;border-bottom:1px solid var(--carta-dark);">
      <div style="display:flex;justify-content:space-between;align-items:baseline;">
        <strong style="font-family:Playfair Display,serif;font-size:16px;">${r}</strong>
        <span style="font-family:DM Mono,monospace;font-size:12px;color:var(--rosso);">${formatEur(v.spesa)}</span>
      </div>
      <div style="margin-top:4px;">${unici.map(p => `<span class="ricetta-tag">${p}</span>`).join('')}</div>
    </div>`;
  }).join('');
}

// ============================================================
// EXPORT EXCEL
// ============================================================
function exportExcel() {
  if (acquisti.length === 0) { showToast('Nessun acquisto da esportare'); return; }
  exportToCSV(acquisti, `Acquisti_SolFa_${new Date().toISOString().split('T')[0]}.csv`);
}

function exportArchivioExcel() {
  const dal = prompt('Esporta archivio dal (AAAA-MM-GG) ‚Äî lascia vuoto per tutto:', '');
  const al  = prompt('al (AAAA-MM-GG) ‚Äî lascia vuoto per tutto:', '');

  let tutti = [...acquisti];
  archivio.forEach(p => tutti.push(...p.acquisti));
  if (dal) tutti = tutti.filter(a => !a.data || a.data >= dal);
  if (al)  tutti = tutti.filter(a => !a.data || a.data <= al);

  if (tutti.length === 0) { showToast('Nessun acquisto nel periodo'); return; }
  exportToCSV(tutti, `Archivio_SolFa_${new Date().toISOString().split('T')[0]}.csv`);
}

function exportToCSV(acqs, filename) {
  const sorted = [...acqs].sort((a,b) => (a.data||'').localeCompare(b.data||''));
  const totale = sorted.reduce((s,a) => s+a.totale, 0);

  const BOM = '\uFEFF';
  let csv = BOM + 'Data;Prodotto;Categoria;Quantit√†;U.M.;Prezzo Unitario (‚Ç¨);Totale (‚Ç¨)\r\n';
  sorted.forEach(a => {
    csv += [
      formatDataFull(a.data),
      `"${a.prodottoNome}"`,
      a.categoria,
      String(a.qty).replace('.',','),
      a.um,
      String(a.prezzoUnit.toFixed(2)).replace('.',','),
      String(a.totale.toFixed(2)).replace('.',',')
    ].join(';') + '\r\n';
  });
  csv += `\r\n;;;;;;TOTALE;${totale.toFixed(2).replace('.',',')}\r\n`;

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  showToast('File scaricato!');
}

// ============================================================
// MODAL
// ============================================================
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) closeModal(o.id); });
});

// ============================================================
// TOAST
// ============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ============================================================
// KEYBOARD
// ============================================================
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
  }
});

// Init analisi date
(function() {
  const oggi = new Date();
  document.getElementById('analisi-al').value = oggi.toISOString().split('T')[0];
  const lun = getMonday(oggi);
  document.getElementById('analisi-dal').value = lun.toISOString().split('T')[0];
})();
</script>
</body>
</html>
